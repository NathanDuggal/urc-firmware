name: CI
on:
  pull_request:
    branches: [ master ]
    types: [ opened, synchronize, closed ]
  push:
    branches-ignore:
      - master

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        
      - name: Setup the Environment
        shell: bash
        run: | 
          # Exit immediately if a command exits with a non-zero status.
          set -e

          # Enable the globstar shell option
          shopt -s globstar
          
          # Make sure we are inside the github workspace
          cd $GITHUB_WORKSPACE

      - name: Export PIO files
        shell: bash
        run: |
          # Source the PlatformIO setup files
          export PATH=$PATH:~/.platformio/penv/bin

      - name: Build PlatformIO
        shell: bash
        run: |
          pio run
  
  format:
    name: Formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        
      - name: Run clang-format
        shell: bash
        run: | 
          make format